# 1计算机系统概述

## 1.1 操作系统的基本概念

### 1.1.1 操作系统的概念

常见：MacOS，ipadOS，Windows，Android，iOS，HarmonyOS，Linux

计算机系统自下而上可大致分为4 部分：硬件（裸机）、操作系统、应用程序和用户（这里的划分与计算机组成原理中的分层不同）。

操作系统(Operati ng System, OS) 是指控制和管理整个计算机系统的硬件与软件资源，合理地组织、调度计算机的工作与资源的分配，进而为用户和其他软件提供方便接口与环境的程序集合。

操作系统管理各种计算机硬件，为应用程序提供基础，并充当计算机硬件与用户之间的**中介**。操作系统是计算机系统中最基本的系统软件。最接近硬件的一层软件。

接口：操作系统提供了正确使用这些资源的方法。

### 1.1.2 操作系统的特征

操作系统的基本特征包括并发、共享、虚拟和异步。

1.并发(Concurrence)

指计算机系统中同时存在多个运行的程序。

同一时间间隔（并发）和同一时刻（并行）的区别         

- 单处理机环境vs多处理机
- 宏观vs微观	同时vs交替

2.共享(Sharing)

是指系统中的资源可供内存中多个**并发**执行的进程共同使用。

(1) 互斥共享方式

在一段时间内只允许一个进程访问该资源。

打印机

资源空闲---->分配进程--->等待---->释放资源---->资源空闲

临界资源：在一段时间内只允许一个进程访问的资源称为临界资源。

计算机系统中的大多数物理设备及某些软件中所用的栈、变量和表格，都属于临界资源，它们都要求被互斥地共享。

(2) 同时访问方式

在一段时间内由多个进程“同时”（通常宏观 == 微观 交替）访问



并发和共享是操作系统两个最基本的特征，两者之间互为存在的条件： 

1⃣️资源共享是以程序的并发为条件的，若系统不允许程序并发执行，则自然不存在资源共享问题

2⃣️若系统不能对资源共享实施有效的管理，则必将影响到程序的并发执行，甚至根本无法并发执行

3.虚拟(Virtual)

虚拟是指把一个物理上的实体变为若干**逻辑上**的对应物。 虚vs实

操作系统中利用了多种虚拟技术来实现虚拟处理器、虚拟内存和虚拟外部设备（IO 设备）等。

空分复用技术--虚拟存储器

时分复用技术--虚拟处理器

4.异步(Asynchronism)

进程的异步性 走走停停

### 1.1.3 操作系统的目标和功能

1.操作系统作为计算机系统资源的管理者，有4个功能：

(1) 处理机管理 == 进程的管理（创建，运行，消亡）

主要功能包括进程控制、进程同步、进程通信、死锁处理、处理机调度等。

(2) 存储器管理

主要包括内存分配与回收、地址映射、内存保护与共享和内存扩充等功能。

(3) 文件管理

计算机中的信息都是以文件的形式存在的

文件管理包括文件存储空间的管理、目录管理及文件读写管理和保护等。

(4) 设备管理

设备管理的主要任务是完成用户的I/0 请求，方便用户使用各种设备，并提高设备的利用率（摄像头等）

主要包括缓冲管理、设备分配、设备处理和虚拟设备等功能。



2.操作系统作为用户与计算机硬件系统之间的接口

封装思想：操作系统把一些丑陋的硬件功能封装成简单易用的服务，使用户能更方 便地使用计算机，用户无需关心底层硬件的原理，只需要对操作系统发出命令即可

(1)命令接口（用户）

联机命令接口又称**交互式**命令接口，适用分时或实时系统的接口。

用户通过控制台或终端输入操作命令，向系统提出各种服务要求。

用户每输入一条命令，控制权就转给操作系统的命令解释程序，然后由命令解释程序解释并执行输入的命令，完成指定的功能。之后，控制权转回控制台或终端，此时用户又可输入下一条命令。



脱机命令接口又称批处理命令接口，适用批处理系统，它由一组作业控制命令组成。

清单

(2) 程序接口（写代码用）
程序接口由一组系统调用（也称广义指令）组成。

系统调用类似于函数调用，是应用程序请求操作系统服务的唯一方式。

图形用户界面(GUI)，即图形接口。GUI 最终是通过调用程序接口实现的.



3.操作系统实现了对计算机资源的扩充

整合，组织

操作系统所提供的资源管理功能和方便用户的各种服务功能，将裸机改造成功能更强、使用更方便的机器；

## 1.2 操作系统发展历程

### 1.2.1 手工操作阶段

纸带打孔：有孔1；无孔0

人-->纸带机-->计算机-->纸带机-->人

缺点： 等待手工操作，人机矛盾（资源利用低）；用户独占全机。

### 1.2.2 批处理阶段

多个用户输入

分为单道批处理系统、多道批处理系统（多道程序设计技术出现以后）。

1. 单道批处理系统（操作系统的雏形）

   引入脱机输入/输出技术（用外围机+磁带完成），并由监督程序负责控制作业的输入、输出

   脱机处理：减少了CPU的空闲时间。提高了I/O速度。解决独占设备问题，可以多个用户通过纸带机输入

   人-->纸带机-->外围机-->磁带-->计算机

   主要特征如下：

   1)自动性

   2)顺序性。磁带上的各道作业顺序地进入内存，即先调入内存的作业先完成。

   3)单道性。内存中仅有一道程序运行，即监督程序每次从磁带上只调入一道程序进入内存运行

   为了进一步提高资源的利用率和系统的吞吐量，引入了多道程序技术

2. 多道批处理系统（操作系统正式诞生）

   支持多道程序并发运行，共享系统中的各种硬／软件资源。


   优点：资源利用率高

   缺点：不提供人机交互能力（调试，运行时输入参数）

### 1.2.3 分时操作系统

分时操作系统：计算机以**时间片**为单位轮流为各个用户/作业服务，各个用户可通过终端与计算机进行交互。 

特征：
l) 同时性（多路性），多个终端用户同时使用一台计算机，和多道批处理系统差不多

2）交互性：

3）独立性：并且用户对计算机的操作相互独立，感受不到别人的存在。

4）及时性：用户请求能在很短时间内获得响应。

主要缺点：不能优先处理一些紧急任务。操作系统对各个用户/作业都是完全公平的，循环地为每个用户， 作业服务一个时间片，不区分任务的紧急性。

### 1.2.4 实时操作系统

能在某个时间限制内完成某些紧急任务而不需要时间片排队。

时间限制两种情况：

- 硬实时系统：某个动作必须绝对地在规定的时刻（或规定的时间范围）发生（飞行自动控制系统，导弹控制系统）
- 软实时系统：偶尔违反时间规定且不会引起任何永久性的损害（订票系统）

计算机系统接收到外部信号后及时进行处理，并在严格的时限内处理完接收的事件。

实时操作系统的主要特点是及时性和可靠性。

### 1.2.5 网络操作系统和分布式计算机系统

网络操作系统：实现网络中各种资源的共享（如文件共享）和各台计算机之间的通信。

分布式操作系统：主要特点是分布性和并行性。系统中的各台计算机地位相同，任何工作都可以分布在这些计算机上，由它们并行、协同完成同一任务。

### 1.2.6 个人计算机操作系统

个人计算机操作系统：Windows Linux MacOS

嵌入式操作系统、服务器操作系统、智能手机操作系统等

## 1.3 操作系统运行环境

### 1.3.0 预备知识

程序是如何运行的？

C代码-->编译器编译-->机器指令（二进制）-->CPU执行

“指令”：处理器(CPU)能识别、执行的最基本命令，是二进制机器指令

### 1.3.1 处理器运行模式

两种程序：

- 内核程序：（组成操作系统）内核，有内核就够了，Docker
- 应用程序：被内核程序管

两种指令：

- 特权指令：内核程序，影响大，内存清零指令、I/O 指令；
- 非特权指令：应用程序，内核程序

CPU两种运行模式：

- 内核态（又称管态、核心态）：内核程序；特权指令，非特权指令
- 用户态（目态）：应用程序；非特权指令

CPU 某个寄存器的某二进制位，表示CPU两种运行模式



内核态、用户态的切换：

内核态-->用户态（操作系统程序）：执行一条特权指令，寄存器的标志位为“用户态”，操作系统让出CPU使用权

用户态-->内核态（硬件）：触发中断信号，操作系统强行夺回CPU的使用权

中断情况：用户态时试图运行特权指令；凡需要操作系统介入的地方



CPU过程：

开机 内核态 内核程序-->启动应用 用户态 应用程序 -->应用试图 特权指令-->中断信号-->内核态 中断信号的内核程序-->启动应用 用户态 应用程序



大多数操作系统的内核包括4方面：

- 时钟管理：

  - 向用户提供标准的系统时间。
  - 时钟中断的管理，进程的切换。分时操作系统时间片调度

- 中断机制：

  多道程序运行环境 CPU利用率 进程的管理和调度

  内核负责保护和恢复中断现场的信息，转移控制权到相关程序

  减少中断的处理时间 增加并行处理能力

- 原语：

  操作系统按层次结构设计，最底层公用小程序，各自完成一个操作。

  特点：

  - 原子性，一气呵成
  - 运行时间短，调用频繁

  定义为原语：关闭中断，所有动作完成后再打开中断。

- 系统控制的数据结构及处埋：

  数据结构很多，管理，常见的操作：

  - 进程管理。状态，调度，分派、创建，撤销
  - 存储器管理。空间分配和回收、内存信息保护程序、代码对换程序。
  - 设备管理。缓冲区管理、设备分配和回收。

### 1.3.2 中断和异常的概念

中断需求：

- 内核夺取CPU控制权才能转交给其他应用程序，并发，中断
- 应用程序想使用核心态的功能

广义的中断分类：

- 内中断 == 异常 == 例外：

  - 与当前执行的指令有关；中断信号的来自CPU内部

  - 分类：

    - 自陷指令 == 访管指令 == 陷入指令 == Trap指令：

      应用程序故意引发；应用程序想请求操作系统内核的服务，应用程序执行陷入指令，陷入指令引发内中断信号。

    - 故障 Fault：

      错误条件引起，可能被内核程序修复。修复后把CPU使用权还给应用程序，让它继续执行。缺页故障

    - 终止 Abort：

      致命错误引起，内核程序无法修复，终止该应用程序。整数除0、非法使用特权指令

- 外中断 == 中断：

  - 中断信号的来自CPU外部
  - 分类：
    - 时钟中断：固定时间片已到，计时、启动定时运行的任务，并发
    - I/O中断请求：设备输入输出处理已经完成

软件中断（程序性异常）和硬件中断：

- 软件中断（程序性异常）：故障异常和自陷异常
- 硬件中断：终止异常和外部中断

中断机制的基本原理：

不同的中断信号，不同的中断处理程序来处理。

CPU检测到中断信号-->断信号的类型-->查询“中断向量表”-->找到相应的中断处理程序（内核程序）在内存中的存放位置

### 1.3.3 系统调用

应用程序可以通过系统调用来请求获得操作系统内核的服务



系统调用与库函数的区别：

- 系统调用是操作系统提供的接口：程序接口（写代码用）：由一组系统调用（广义指令）组成。
- 应用程序可以直接用系统调用；可以用库函数
- 编程语言提供库函数，有的库函数封装系统调用（计算）

系统调用的必要性：打印（并发打印？操作系统内核管理）

使用范围：

凡是与共享资源有关的操作（如存储分配、I/O操作、文件管理等），都必须通过系统调用的方式向操作系统内核提出服务请求，由操作系统内核代为完成。

按功能分类：

- 设备管理。设备的请求或释放，以及设备启动等功能。
- 文件管理。文件的读、写、创建及删除等功能。
- 进程控制。进程的创建、撤销、阻塞及唤醒等功能。
- 进程通信。进程之间的消息传递或信号传递等功能。
- 内存管理。内存的分配、回收以及获取作业占用内存区大小及始址等功能。

系统调用过程：

应用程序 用户态 --> 想要系统调用 --> 给CPU寄存器传参（系统调用类型等）-->

应用程序 陷入指令 --> 引发 内中断 --> 中断处理程序 系统调用入口程序 内核态--> 

查看寄存器参数 --> 系统调用类型对应的处理程序 --> 查看使用其他参数 --> 用户态 继续执行
